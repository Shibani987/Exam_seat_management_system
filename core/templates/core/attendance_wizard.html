{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendance Sheet Wizard - Exam Management</title>
  <link rel="stylesheet" href="{% static 'core/css/dash_board.css' %}?v=3">
  <style>
    .wizard-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    .step-indicator {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      align-items: center;
    }
    .step-indicator .step {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: bold;
    }
    .step-indicator .step .number {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
    }
    .step-indicator .step.active .number {
      background: #2196F3;
      color: white;
    }
    .step-content {
      background: white;
      padding: 24px;
      border-radius: 8px;
      border: 1px solid #eee;
      margin-bottom: 20px;
    }
    .step-content h3 {
      margin-top: 0;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    .form-group input[type="text"] {
      width: 100%;
      max-width: 500px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .files-table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid #ddd;
    }
    .files-table th {
      background: #f5f5f5;
      padding: 12px;
      text-align: left;
      border-bottom: 2px solid #ddd;
      font-weight: 600;
    }
    .files-table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
    }
    .files-table input[type="radio"] {
      cursor: pointer;
    }
    .button-group {
      display: flex;
      gap: 8px;
      margin-top: 20px;
    }
    .button-group button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    .button-group .btn-primary {
      background: #2196F3;
      color: white;
    }
    .button-group .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .button-group .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }
    .button-group .btn-secondary:hover {
      background: #e0e0e0;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <button class="hamburger-btn" id="hamburgerBtn"><span></span><span></span><span></span></button>
  <div class="sidebar" id="sidebar">
    <button class="close-btn" id="closeBtn">✕</button>
    <div>
      <h2>admin panel</h2>
      <a href="{% url 'dashboard' %}" class="tab-link">create exam</a>
      <a href="{% url 'dashboard' %}?tab=generate-sheet" class="tab-link active">generate sheet attendance</a>
      <a href="{% url 'dashboard' %}?tab=upload-data" class="tab-link">upload student data</a>
      <a href="{% url 'dashboard' %}?tab=admin-emails" class="tab-link">admin emails</a>
      <a href="{% url 'dashboard' %}?tab=qr-tab" class="tab-link">universal qr</a>
    </div>
    <div class="logout">
      <a href="{% url 'admin_logout' %}">logout →</a>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main">
    <div class="wizard-container">
      <h1>Attendance Sheet Setup Wizard</h1>
      <p style="color: #666; margin-bottom: 30px;">Configure and generate attendance sheets in two simple steps.</p>

      <!-- Step Indicator -->
      <div class="step-indicator">
        <div class="step active" id="stepIndicator1">
          <div class="number">1</div>
          <span>Exam Name</span>
        </div>
        <div style="flex: 1; height: 2px; background: #e0e0e0;"></div>
        <div class="step" id="stepIndicator2">
          <div class="number">2</div>
          <span>Select Files</span>
        </div>
      </div>

      <!-- Step 1: Exam Name -->
      <div class="step-content" id="step1Content">
        <h3>Step 1 — Enter Exam Name</h3>
        <div class="form-group">
          <label for="examName">Exam Name:</label>
          <input type="text" id="examName" placeholder="e.g., Midterm Exam - Data Structures" />
        </div>
        <div class="button-group">
          <button class="btn-primary" id="nextBtn" disabled>Next →</button>
          <button class="btn-secondary" id="cancelBtn">Cancel</button>
        </div>
      </div>

      <!-- Step 2: Select Files -->
      <div class="step-content" id="step2Content" style="display: none;">
        <h3>Step 2 — Select Student Data Files</h3>
        
        <div class="form-group">
          <label>Filter Files:</label>
          <div style="display: flex; gap: 8px;">
            <input type="text" id="fileFilter" placeholder="Search by file name..." style="flex: 1; max-width: 400px;" />
            <button class="btn-secondary" id="showAllBtn">Show All</button>
          </div>
        </div>

        <div style="margin-top: 20px; margin-bottom: 20px; max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
          <table class="files-table" style="border: none;">
            <thead>
              <tr>
                <th style="width: 50px;"><input type="checkbox" id="selectAllFiles" /></th>
                <th>File Name</th>
                <th>Uploaded</th>
                <th style="width: 100px;">Student Count</th>
              </tr>
            </thead>
            <tbody id="filesTableBody">
              <tr>
                <td colspan="4" style="text-align: center; padding: 30px; color: #999;">Loading files...</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="button-group">
          <button class="btn-primary" id="generateBtn" disabled>Generate Attendance Sheet</button>
          <button class="btn-secondary" id="backBtn">← Back</button>
        </div>
      </div>
    </div>
  </div>

  <script src="{% static 'core/js/dash_board.js' %}"></script>
  <script>
    // Attendance Wizard Logic
    const examNameInput = document.getElementById('examName');
    const nextBtn = document.getElementById('nextBtn');
    const backBtn = document.getElementById('backBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const generateBtn = document.getElementById('generateBtn');
    const fileFilter = document.getElementById('fileFilter');
    const showAllBtn = document.getElementById('showAllBtn');
    const selectAllFiles = document.getElementById('selectAllFiles');
    const filesTableBody = document.getElementById('filesTableBody');

    let allFiles = [];
    let selectedFiles = [];

    // Step 1: Enable Next button when exam name is entered
    examNameInput.addEventListener('input', () => {
      nextBtn.disabled = examNameInput.value.trim().length === 0;
    });

    nextBtn.addEventListener('click', () => {
      document.getElementById('step1Content').style.display = 'none';
      document.getElementById('step2Content').style.display = 'block';
      document.getElementById('stepIndicator1').classList.remove('active');
      document.getElementById('stepIndicator2').classList.add('active');
      fetchUploadedFiles();
    });

    backBtn.addEventListener('click', () => {
      document.getElementById('step2Content').style.display = 'none';
      document.getElementById('step1Content').style.display = 'block';
      document.getElementById('stepIndicator2').classList.remove('active');
      document.getElementById('stepIndicator1').classList.add('active');
      generateBtn.disabled = true;
    });

    cancelBtn.addEventListener('click', () => {
      if (confirm('Are you sure you want to cancel? Any unsaved changes will be lost.')) {
        window.location.href = '{% url 'dashboard' %}?tab=generate-sheet';
      }
    });

    // Fetch uploaded files
    function fetchUploadedFiles() {
      filesTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #999;">Loading files...</td></tr>';
      
      fetch('/get_uploaded_files/?t=' + Date.now())
        .then(r => r.json())
        .then(data => {
          if (data.status === 'success' && Array.isArray(data.files)) {
            allFiles = data.files;
            renderFilesTable(allFiles);
          } else {
            filesTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #999;">No files found.</td></tr>';
          }
        })
        .catch(err => {
          filesTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #c62828;">Error loading files.</td></tr>';
          console.error('Error:', err);
        });
    }

    // Render files table
    function renderFilesTable(files) {
      if (!files || files.length === 0) {
        filesTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #999;">No files uploaded yet.</td></tr>';
        return;
      }

      filesTableBody.innerHTML = '';
      files.forEach(file => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><input type="checkbox" class="fileCheckbox" value="${file.id}" /></td>
          <td>${file.file_name}</td>
          <td>${file.uploaded_at || 'N/A'}</td>
          <td style="text-align: center;">${file.student_count || 0}</td>
        `;
        filesTableBody.appendChild(row);

        row.querySelector('.fileCheckbox').addEventListener('change', updateGenerateBtn);
      });
    }

    // File filter
    fileFilter.addEventListener('input', () => {
      const q = fileFilter.value.trim().toLowerCase();
      const filtered = allFiles.filter(f => f.file_name.toLowerCase().includes(q));
      renderFilesTable(filtered);
    });

    showAllBtn.addEventListener('click', () => {
      fileFilter.value = '';
      renderFilesTable(allFiles);
    });

    // Select all files
    selectAllFiles.addEventListener('change', () => {
      document.querySelectorAll('.fileCheckbox').forEach(cb => {
        cb.checked = selectAllFiles.checked;
      });
      updateGenerateBtn();
    });

    // Update Generate button state
    function updateGenerateBtn() {
      const checked = document.querySelectorAll('.fileCheckbox:checked');
      generateBtn.disabled = checked.length === 0;
    }

    // Generate button
    generateBtn.addEventListener('click', () => {
      const selected = Array.from(document.querySelectorAll('.fileCheckbox:checked')).map(cb => cb.value);
      if (selected.length === 0) return;

      const examName = encodeURIComponent(examNameInput.value.trim());
      const fileIds = selected.join(',');
      
      // For now, show success message (backend implementation will follow)
      alert(`Exam: ${examNameInput.value}\nSelected Files: ${selected.length}\n\nAttendance sheet generation will be processed.`);
      
      // Redirect back to dashboard
      window.location.href = '{% url 'dashboard' %}?tab=generate-sheet';
    });

    // Sidebar toggle
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const closeBtn = document.getElementById('closeBtn');
    const sidebar = document.getElementById('sidebar');

    if (hamburgerBtn && sidebar && closeBtn) {
      hamburgerBtn.addEventListener('click', () => {
        hamburgerBtn.classList.toggle('active');
        sidebar.classList.toggle('active');
      });

      closeBtn.addEventListener('click', () => {
        hamburgerBtn.classList.remove('active');
        sidebar.classList.remove('active');
      });
    }
  </script>
</body>
</html>
