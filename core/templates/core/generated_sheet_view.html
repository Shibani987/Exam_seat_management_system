{% load static %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generated Attendance Sheets - {{ exam_name }}</title>
  <link rel="stylesheet" href="{% static 'core/css/attendance_sheet_print.css' %}">
  <style>body{margin:0;}.print-btn{padding:8px 12px;margin:10px;}</style>
</head>
<body>
  <p style="margin:10px 0;"><a href="{% url 'dashboard' %}?tab=generate-sheet" class="no-print" style="color:#1976d2;text-decoration:none;">‚Üê Back to Dashboard</a></p>
  <button class="print-btn no-print" onclick="handlePrint()">Print All</button>
  <div id="sheetsPreview"></div>
  {% comment %} embed data safely for javascript {% endcomment %}
  {{ sheets|json_script:"initialSheets" }}
  {{ exam_name|json_script:"initialExamName" }}
  <script>
    const initialSheets = JSON.parse(document.getElementById('initialSheets').textContent);
    const initialExamName = JSON.parse(document.getElementById('initialExamName').textContent);

    function waitForRenderAndPrint(timeoutMs = 3000) {
      const container = document.getElementById('sheetsPreview');
      const start = Date.now();

      function check() {
        // If items rendered, wait for images to load, then print
        if (container && container.children.length > 0) {
          const imgs = container.querySelectorAll('img');
          if (imgs.length === 0) {
            window.print();
            return;
          }
          let remaining = imgs.length;
          imgs.forEach(img => {
            if (img.complete) {
              remaining -= 1;
              if (remaining === 0) window.print();
            } else {
              img.addEventListener('load', () => { remaining -= 1; if (remaining === 0) window.print(); });
              img.addEventListener('error', () => { remaining -= 1; if (remaining === 0) window.print(); });
            }
          });
          // safety: if images don't finish in 2s, print anyway
          setTimeout(() => { if (remaining > 0) window.print(); }, 2000);
        } else if (Date.now() - start < timeoutMs) {
          setTimeout(check, 100);
        } else {
          // fallback: nothing rendered, still open print
          window.print();
        }
      }
      check();
    }

    function handlePrint() {
      // give rendering a small headstart then wait for complete render
      setTimeout(() => waitForRenderAndPrint(), 50);
    }
  </script>
  <script src="{% static 'core/js/attendance_wizard.js' %}"></script>
  <script>
    // once script loads, render
    document.addEventListener('DOMContentLoaded', () => {
      showStep3(initialSheets, initialExamName);
    });
  </script>
</body>
</html>
