{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Exam Management</title>

  <link rel="stylesheet" href="{% static 'core/css/dash_board.css' %}?v=3">
</head>
<body>
  <!-- Sidebar Toggle (Mobile) -->
  <button class="hamburger-btn" id="hamburgerBtn">
    <span></span>
    <span></span>
    <span></span>
  </button>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <button class="close-btn" id="closeBtn">✕</button>
    <div>
      <h2>admin panel</h2>
      <a href="#" class="tab-link active" data-tab="create-exam">create exam</a>
      <a href="#" class="tab-link" data-tab="upload-data">upload student data</a>
      <a href="#" class="tab-link" data-tab="admin-emails">admin emails</a>
      <a href="#" class="tab-link" data-tab="qr-tab">universal qr</a>
    </div>
    <div class="logout">
      <a href="{% url 'admin_logout' %}">logout →</a>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main">

    <!-- ================== CREATE EXAM TAB ================== -->
    <div class="tab-content active" id="create-exam">
      <div class="header">
        <h1>Dashboard Overview</h1>
        <button class="new-exam-btn" id="newExamBtn">+ New Exam</button>
      </div>

      <div class="stats">
        <div class="card">
          <h3>Total Exams Created</h3>
          <p id="totalExamsCount">0</p>
        </div>
        <div class="card">
          <h3>Ongoing Exams</h3>
          <p id="ongoingExamsCount">0</p>
        </div>
        <div class="card">
          <h3>Upcoming Exams</h3>
          <p id="upcomingExamsCount">0</p>
        </div>
      </div>

      <div class="exam-list">
        <h2>Scheduled Exams</h2>
        <div id="examsContainer">
          <p style="text-align: center; color: #999; padding: 20px;">Loading exams...</p>
        </div>
      </div>
    </div>

    <!-- ================== UPLOAD STUDENT DATA TAB ================== -->
    <div class="tab-content" id="upload-data">
      <h1>Upload Student Data</h1>
      <p class="upload-description">
        Upload student data files semester, year & department wise.
      </p>

      <form class="upload-form" method="POST" enctype="multipart/form-data" action="{% url 'upload_data' %}">
        {% csrf_token %}
        <div class="form-row">
          <div class="form-group">
            <label>Select Year:</label>
            <select name="year" id="yearSelect" required>
              <option value="">--Select Year--</option>
              {% for y in years %}
              <option value="{{ y }}">{{ y }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label>Select Semester:</label>
            <select name="semester" id="semesterSelect" required>
              <option value="">--Select Semester--</option>
              {% for i in "12345678" %}
              <option value="{{ forloop.counter }}">{{ forloop.counter }} Semester</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Select Department:</label>
            <select name="department" id="deptSelect" required>
             <option value="">--Select Department--</option>
<option value="CSE">CSE</option>
<option value="ECE">ECE</option>
<option value="EEE">EEE</option>
<option value="IT">IT</option>
<option value="ME">ME</option>
<option value="CE">CE</option>
<option value="AIML">AIML</option>
<option value="CSBS">CSBS</option>
<option value="BCA">BCA</option>
<option value="BBA">BBA</option>

            </select>
          </div>

          <div class="form-group">
            <label>Select File:</label>
            <input type="file" name="file" id="fileInput" accept=".csv,.xlsx,.xls" required>
          </div>
        </div>

        <button class="upload-btn" id="uploadBtn" disabled>Upload</button>
      </form>

<div class="uploaded-files">
    <h2>Uploaded Files</h2>
    <table class="files-table">
      <thead>
        <tr>
          <th>File Name</th>
          <th>Year</th>
          <th>Semester</th>
          <th>Department</th>
          <th>Uploaded At</th>
          <th>Action</th> <!-- New column -->
        </tr>
      </thead>
      <tbody>
        {% if uploaded_files %}
          {% for file in uploaded_files %}
          <tr>
            <td>{{ file.file_name }}</td>
            <td>{{ file.year }}</td>
            <td>{{ file.semester }}</td>
            <td>{{ file.department }}</td>
            <td>{{ file.uploaded_at|date:"Y-m-d H:i" }}</td>
            <td>
              <button type="button" class="view-file-btn" data-file-id="{{ file.id }}" style="background:#2196F3; color:#fff; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; margin-right:5px;">View</button>
              <form method="POST" action="{% url 'delete_student_file' file.id %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" onclick="return confirm('Are you sure you want to delete this file and all its students?');">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        {% else %}
        <tr>
          <td colspan="6" style="text-align:center; padding:20px; color:#999;">
            No files uploaded yet.
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>
</div>

    </div>

    <!-- ================== ADMIN EMAILS TAB ================== -->
    <div class="tab-content" id="admin-emails">
      <h1>Manage Eligible Admin Emails</h1>
      <p class="upload-description">Upload the list of emails that are allowed to use the 'Forgot Password' flow.</p>

      <form class="upload-form" method="POST" action="{% url 'manage_admin_emails' %}">
        {% csrf_token %}
        <div class="form-row">
          <div class="form-group" style="width:100%; max-width:900px;">
            <label for="id_email">Add a single email</label><br>
            <input type="email" name="email" id="id_email" class="admin-email-input" placeholder="name@example.com">
            <button class="upload-btn" type="submit" style="margin-top:8px;">Add</button>
          </div>
        </div>

        <div class="form-row" style="margin-top:12px;">
          <div class="form-group" style="width:100%;">
            <label for="id_emails">Or paste emails (one per line)</label><br>
            <textarea name="emails" id="id_emails" rows="5" style="width:100%; padding:8px;"></textarea>
          </div>
        </div>

        <button class="upload-btn" type="submit" style="margin-top:8px;">Add Pasted Emails</button>
      </form>

      {% if messages %}
        <div style="margin-top:12px;">
          {% for message in messages %}
            <p style="color: {% if message.tags == 'error' %}#c62828{% else %}#2e7d32{% endif %};">{{ message }}</p>
          {% endfor %}
        </div>
      {% endif %}

      {% if eligible_emails and eligible_emails.count > 0 %}
      <div style="margin-top:20px;">
        <h3>Eligible Emails</h3>
        <ul>
          {% for e in eligible_emails %}
            <li>
              {{ e.email }} (added: {{ e.added_at|date:'Y-m-d H:i' }})
              <form method="POST" action="{% url 'delete_admin_email' e.id %}" style="display:inline; margin-left:10px;">
                {% csrf_token %}
                <button type="submit" class="admin-email-delete-btn" onclick="return confirm('Delete this eligible email?');">Delete</button>
              </form>
            </li>
          {% empty %}
            <li>No emails yet.</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}



  </div>

    <!-- ================== UNIVERSAL QR TAB ================== -->
    <div class="tab-content" id="qr-tab">
      <h1>Universal QR Code</h1>
      <p class="upload-description">
       Scan to access student portal. Students can scan this QR and then enter their registration number to find their seat.
      </p>

      <div style="text-align:center; margin-top:20px;">
        <img src="{{ qr_url }}" alt="Universal QR" style="max-width:320px; border:3px solid #28a745; padding:10px; border-radius:8px;">
        <div style="margin-top:12px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
          <button type="button" id="printQrBtn" class="upload-btn">Print QR</button>
         
          
        </div>
        <p style="margin-top:10px; color:#666;">
          <strong>Student Portal URL:</strong><br>
          <a href="{{ student_portal_url }}" target="_blank" style="color:#1976d2; word-break:break-all;">{{ student_portal_url }}</a>
        </p>
       
      </div>
    </div>

  <!-- ================== MODAL FOR NEW EXAM ================== -->
  <div class="modal" id="newExamModal">
    <div class="modal-content">
      <button class="modal-close" id="modalCloseBtn">×</button>
      <h1 class="modal-title">Create New Exam</h1>
      
      <div class="exam-card">
        <h2>Upload Student Data</h2>
        <p class="exam-card-description">
          Please upload student data according to <strong>Semester</strong>, <strong>Year</strong>, and <strong>Department</strong>.
          If you've already uploaded, you can proceed by clicking Continue below.
        </p>
        
        <div class="exam-card-buttons">
          <button class="btn-upload">Upload Student Data</button>
          <button class="btn-continue">Continue →</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ================== MODAL FOR FILE STUDENTS ================== -->
  <div class="modal" id="fileStudentsModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:8px; max-width:1000px; max-height:80vh; width:95%; overflow-y:auto; box-shadow:0 5px 15px rgba(0,0,0,0.3);">
      <div style="padding:12px 20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; gap:12px;">
        <div>
          <h2 id="fileStudentsTitle" style="margin:0; font-size:1.15em;">File Students</h2>
          <div id="fileStudentsInfo" style="font-size:0.9rem; color:#555; margin-top:6px;"></div>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="addFileStudentBtn" style="background:#4caf50; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">Add Student</button>
          <button id="saveFileStudentsBtn" style="background:#1976d2; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">Save Changes</button>
          <button id="closeFileStudentsModal" style="background:none; border:none; font-size:1.4em; cursor:pointer;">×</button>
        </div>
      </div>
      <div style="padding:16px;">
        <div id="fileStudentsTableContainer" style="overflow-x:auto;">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="background:#f0f0f0;">
                <th style="padding:10px; text-align:left; border-bottom:1px solid #ddd;">Name</th>
                <th style="padding:10px; text-align:left; border-bottom:1px solid #ddd;">Roll Number</th>
                <th style="padding:10px; text-align:left; border-bottom:1px solid #ddd;">Registration Number</th>
                <th style="padding:10px; text-align:left; border-bottom:1px solid #ddd;">Department</th>
                <th style="padding:10px; text-align:left; border-bottom:1px solid #ddd;">Year</th>
                <th style="padding:10px; text-align:left; border-bottom:1px solid #ddd;">Semester</th>
                <th style="padding:10px; text-align:left; border-bottom:1px solid #ddd;">Action</th>
              </tr>
            </thead>
            <tbody id="fileStudentsTableBody">
              <tr><td colspan="7" style="text-align:center; padding:20px;">Loading students...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="{% static 'core/js/dash_board.js' %}?v=<?php echo time(); ?>"></script>
<script>
    const examSetupUrl = "{% url 'exam_setup' %}";
    
    function loadExams() {
        const container = document.getElementById('examsContainer');
        
        fetch('/get-all-exams/?t=' + Date.now())
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success' && data.exams) {
                    let ongoingCount = 0, upcomingCount = 0;
                    let html = '';
                    
                    if (data.exams.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No exams found.</p>';
                        return;
                    }

                    data.exams.forEach(exam => {
                        let statusText = 'UPCOMING', bg = '#FFF8E1', color = '#F57F17', border = '#FFD54F';
                        const currentStatus = (exam.status || '').toLowerCase().trim();

                        if (currentStatus === 'ongoing') {
                            statusText = 'ONGOING'; bg = '#E8F5E9'; color = '#2E7D32'; border = '#81C784';
                            ongoingCount++;
                        } else if (currentStatus === 'expired' || currentStatus === 'completed') {
                            statusText = 'COMPLETED'; bg = '#F3E5F5'; color = '#7B1FA2'; border = '#CE93D8';
                        } else {
                            upcomingCount++;
                        }

                        html += `
                        <div style="display:table !important; width:100% !important; background:#fff !important; border-radius:8px !important; padding:15px 20px !important; margin-bottom:15px !important; box-shadow:0 2px 6px rgba(0,0,0,0.05) !important; border: 1px solid #eee !important;">
                            <div style="display:table-cell !important; width:110px !important; padding-right:15px !important; vertical-align:middle !important;">
                                <div style="background:${bg} !important; color:${color} !important; border:1px solid ${border} !important; padding:6px 10px !important; border-radius:4px !important; font-size:0.75rem !important; font-weight:700 !important; text-align:center !important; text-transform:uppercase !important;">
                                    ${statusText}
                                </div>
                            </div>
                            <div style="display:table-cell !important; vertical-align:middle !important;">
                                <div style="font-size:1.1rem !important; color:#222 !important; font-weight:600 !important;">${exam.name}</div>
                                <div style="margin: 5px 0;">
                                    ${(exam.departments || []).map(d => `<span style="background:#e3f2fd !important; color:#0d47a1 !important; font-size:0.75rem !important; padding:2px 8px !important; border-radius:4px !important; margin-right:5px !important;">${d}</span>`).join('')}
                                </div>
                                <div style="font-size:0.85rem !important; color:#666 !important;">
                                    <strong>${exam.student_count}</strong> Students • <strong>${exam.duration_days}</strong> Days Exam
                                </div>
                            </div>
                            <div style="display:table-cell !important; width:160px !important; text-align:right !important; vertical-align:middle !important;">
                                <button style="background:#1976d2 !important; color:#fff !important; border:none !important; padding:8px 12px !important; border-radius:6px !important; cursor:pointer !important;" onclick="window.location.href='/view-exam/${exam.id}/'">View</button>
                                <button style="background:#d32f2f !important; color:#fff !important; border:none !important; padding:8px 12px !important; border-radius:6px !important; cursor:pointer !important; margin-left:8px !important;" onclick="deleteExam(${exam.id})">Delete</button>
                            </div>
                        </div>`;
                    });

                    container.innerHTML = html;
                    document.getElementById('totalExamsCount').textContent = data.exams.length;
                    document.getElementById('ongoingExamsCount').textContent = ongoingCount;
                    document.getElementById('upcomingExamsCount').textContent = upcomingCount;
                }
            })
            .catch(err => { container.innerHTML = '<p style="text-align: center; color: red;">Failed to load exams.</p>'; });
    }

    // Helper: get CSRF cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Delete exam handler
    function deleteExam(examId) {
        if (!confirm('Are you sure you want to permanently delete this exam and ALL its data? This cannot be undone.')) return;
        const csrftoken = getCookie('csrftoken');
        fetch('/delete-exam/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
            body: JSON.stringify({ exam_id: examId })
        })
        .then(r => {
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return r.json();
        })
        .then(resp => {
            if (resp.status === 'success') {
                alert('Exam deleted successfully.');
                loadExams();
            } else {
                alert('Error deleting exam: ' + (resp.message || 'Unknown error'));
            }
        })
        .catch(err => {
            console.error('Delete exam error:', err);
            alert('Failed to delete exam. See console for details.');
        });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadExams();
        // Open a specific tab if ?tab= is present
        const params = new URLSearchParams(window.location.search);
        const tab = params.get('tab');
        if (tab) {
            document.querySelectorAll('.tab-link').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            const link = document.querySelector(`.tab-link[data-tab="${tab}"]`);
            const content = document.getElementById(tab);
            if (link) link.classList.add('active');
            if (content) content.classList.add('active');
        }
    });
    
    // Modal Continue Button
    document.querySelector('.btn-continue')?.addEventListener('click', () => {
      window.location.href = examSetupUrl;
    });

    // File Students Modal Handlers
    let currentFileId = null;
    const fileStudentsModal = document.getElementById('fileStudentsModal');
    const closeFileStudentsModalBtn = document.getElementById('closeFileStudentsModal');
    const addFileStudentBtn = document.getElementById('addFileStudentBtn');
    const saveFileStudentsBtn = document.getElementById('saveFileStudentsBtn');

    closeFileStudentsModalBtn.addEventListener('click', () => {
      fileStudentsModal.style.display = 'none';
      currentFileId = null;
    });

    fileStudentsModal.addEventListener('click', (e) => {
      if (e.target === fileStudentsModal) {
        fileStudentsModal.style.display = 'none';
        currentFileId = null;
      }
    });

    document.addEventListener('click', (e) => {
      if (e.target.classList && e.target.classList.contains('view-file-btn')) {
        const fileId = e.target.getAttribute('data-file-id');
        loadFileStudents(fileId);
      }
      if (e.target && e.target.classList && e.target.classList.contains('remove-file-student')) {
        const tr = e.target.closest('tr');
        if (tr) tr.remove();
      }
    });

    addFileStudentBtn.addEventListener('click', () => {
      const tbody = document.getElementById('fileStudentsTableBody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="padding:10px;" contenteditable="true"></td>
        <td style="padding:10px;" contenteditable="true"></td>
        <td style="padding:10px;" contenteditable="true"></td>
        <td style="padding:10px;" contenteditable="true"></td>
        <td style="padding:10px;" contenteditable="true"></td>
        <td style="padding:10px;" contenteditable="true"></td>
        <td style="padding:10px;"><button class="remove-file-student" style="background:#e53935;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;">Remove</button></td>
      `;
      tbody.prepend(tr);
    });

    saveFileStudentsBtn.addEventListener('click', () => {
      if (!currentFileId) return alert('No file loaded');
      const csrftoken = getCookie('csrftoken');
      const tbody = document.getElementById('fileStudentsTableBody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const updates = [];
      const adds = [];
      rows.forEach(tr => {
        const tds = tr.querySelectorAll('td');
        if (tds.length < 6) return;
        const id = tr.getAttribute('data-id');
        const obj = {
          name: tds[0].textContent.trim(),
          roll_number: tds[1].textContent.trim(),
          registration_number: tds[2].textContent.trim(),
          department: tds[3].textContent.trim(),
          year: tds[4].textContent.trim(),
          semester: tds[5].textContent.trim()
        };
        if (id) {
          obj.id = id;
          updates.push(obj);
        } else {
          adds.push(obj);
        }
      });

      // Perform updates then adds
      Promise.resolve()
        .then(() => {
          if (updates.length === 0) return {status:'noop'};
          return fetch('/update-students/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
            body: JSON.stringify({ students: updates })
          }).then(r => r.json());
        })
        .then(uresp => {
          if (uresp && uresp.status === 'error') throw new Error(uresp.message || 'Update failed');
          if (adds.length === 0) return {status:'noop'};
          return fetch('/add-file-students/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
            body: JSON.stringify({ file_id: currentFileId, students: adds })
          }).then(r => r.json());
        })
        .then(aresp => {
          if (aresp && aresp.status === 'error') throw new Error(aresp.message || 'Add failed');
          alert('Saved successfully');
          loadFileStudents(currentFileId);
        })
        .catch(err => {
          console.error('Save file students error:', err);
          alert('Failed to save changes. See console for details.');
        });
    });

    function loadFileStudents(fileId) {
      const fileStudentsTableBody = document.getElementById('fileStudentsTableBody');
      fileStudentsTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">Loading students...</td></tr>';
      fileStudentsModal.style.display = 'flex';
      currentFileId = fileId;

      fetch(`/get-file-students/?file_id=${fileId}`)
        .then(r => r.json())
        .then(data => {
          if (data.status === 'success') {
            const file = data.file;
            const students = data.students || [];
            document.getElementById('fileStudentsTitle').textContent = `File: ${file.file_name}`;
            document.getElementById('fileStudentsInfo').innerHTML = `Department: ${file.department} | Year: ${file.year} | Semester: ${file.semester} | Total: ${data.total_students}`;
            if (students.length === 0) {
              fileStudentsTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">No students found in this file.</td></tr>';
              return;
            }
            let html = '';
            students.forEach(s => {
              html += `
              <tr data-id="${s.id}">
                <td style="padding:10px;" contenteditable="true">${s.name || ''}</td>
                <td style="padding:10px;" contenteditable="true">${s.roll_number || ''}</td>
                <td style="padding:10px;" contenteditable="true">${s.registration_number || ''}</td>
                <td style="padding:10px;" contenteditable="true">${s.department || ''}</td>
                <td style="padding:10px;" contenteditable="true">${s.year || ''}</td>
                <td style="padding:10px;" contenteditable="true">${s.semester || ''}</td>
                <td style="padding:10px;"><button class="remove-file-student" style="background:#e53935;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;">Remove</button></td>
              </tr>
              `;
            });
            fileStudentsTableBody.innerHTML = html;
          } else {
            alert('Error: ' + (data.message || 'Failed to load students'));
            fileStudentsModal.style.display = 'none';
          }
        })
        .catch(err => {
          console.error('Error loading file students:', err);
          alert('Failed to load file students. See console for details.');
          fileStudentsModal.style.display = 'none';
        });
    }

    // ================== UNIVERSAL QR TAB COPY HELPERS ==================
    const printQrBtn = document.getElementById('printQrBtn');
    const copyQrUrlBtn = document.getElementById('copyQrUrlBtn');
    const copyPortalUrlBtn = document.getElementById('copyPortalUrlBtn');
    const dashboardUrlDisplay = document.getElementById('dashboardUrlDisplay');
    
    // Display dashboard URL (will be set after exam creation)
    function updateDashboardUrl() {
      const currentUrl = window.location.origin + window.location.pathname;
      dashboardUrlDisplay.textContent = currentUrl;
      dashboardUrlDisplay.style.color = '#1976d2';
    }
    
    // Initialize dashboard URL display
    updateDashboardUrl();
    
    if (printQrBtn) {
      printQrBtn.addEventListener('click', () => {
        const qrImg = document.querySelector('#qr-tab img');
        if (qrImg && qrImg.src) {
          const printWindow = window.open('', '', 'width=600,height=700');
          printWindow.document.write(`
            <html>
              <head>
                <title>Print QR Code</title>
                <style>
                  @media print {
                    body { margin: 0; }
                    .no-print { display: none; }
                  }
                  body { 
                    margin: 0; 
                    padding: 20px; 
                    text-align: center; 
                    font-family: Arial, sans-serif; 
                  }
                  h1 { 
                    color: #333; 
                    margin-bottom: 20px; 
                  }
                  img { 
                    max-width: 300px; 
                    border: 3px solid #28a745; 
                    padding: 15px; 
                    border-radius: 8px; 
                    display: block;
                    margin: 0 auto;
                  }
                  p { 
                    color: #666; 
                    margin: 15px 0; 
                    font-size: 14px;
                  }
                  .portal-url {
                    word-break: break-all;
                    font-size: 12px;
                    color: #999;
                    margin-top: 20px;
                  }
                </style>
              </head>
              <body>
                <h1>Universal QR Code</h1>
                <p>Scan to access Student Portal</p>
                <img src="${qrImg.src}" alt="QR Code" onload="window.print();">
                <p class="portal-url">Student Portal: {{ student_portal_url }}</p>
              </body>
            </html>
          `);
          printWindow.document.close();
        } else {
          alert('QR code image not found. Please wait for the page to load completely.');
        }
      });
    }
    
    if (copyQrUrlBtn && navigator.clipboard) {
      copyQrUrlBtn.addEventListener('click', () => {
        navigator.clipboard.writeText('{{ qr_url }}')
          .then(() => alert('QR image URL copied to clipboard'))
          .catch(() => alert('Unable to copy QR URL'));
      });
    }
    if (copyPortalUrlBtn && navigator.clipboard) {
      copyPortalUrlBtn.addEventListener('click', () => {
        navigator.clipboard.writeText('{{ student_portal_url }}')
          .then(() => alert('Student Portal URL copied to clipboard'))
          .catch(() => alert('Unable to copy Student Portal URL'));
      });
    }
</script> 
</body>
</html>
